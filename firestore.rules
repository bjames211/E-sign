rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: get user role from user_roles collection (keyed by email)
    function getUserRole() {
      return get(/databases/$(database)/documents/user_roles/$(request.auth.token.email)).data.role;
    }

    function isAuthenticated() {
      return request.auth != null;
    }

    function isManagerOrAdmin() {
      return isAuthenticated() && getUserRole() in ['admin', 'manager'];
    }

    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }

    // E-sign documents - authenticated can read/create, only Cloud Functions update
    match /esign_documents/{docId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if false; // Only Cloud Functions should update
    }

    // Orders - sales reps see own orders, managers+ see all. Only managers+ can delete.
    match /orders/{orderId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isManagerOrAdmin();
    }

    // Quotes - authenticated can CRUD
    match /quotes/{quoteId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isManagerOrAdmin();
    }

    // Admin options - all read, only managers+ write
    match /admin_options/{optionType} {
      allow read: if isAuthenticated();
      allow write: if isManagerOrAdmin();
    }

    // Counters - all authenticated can read/write (order number generation)
    match /counters/{counterId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // Change orders - authenticated CRUD, only managers+ delete
    match /change_orders/{changeOrderId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isManagerOrAdmin();
    }

    // Payments - authenticated read/create/update, never delete
    match /payments/{paymentId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if false;
    }

    // Payment Ledger - authenticated read/create/update, never delete (void instead)
    match /payment_ledger/{entryId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if false;
    }

    // User roles - all authenticated read, only admins write
    match /user_roles/{email} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Order audit log - authenticated read/create, no update/delete
    match /order_audit_log/{entryId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    // Payment audit log - authenticated read/create, no update/delete
    match /payment_audit_log/{entryId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    // Extracted PDF data - read only, Cloud Functions write
    match /extracted_pdf_data/{docId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    // Mail collection (for email sending via Firebase extension)
    match /mail/{mailId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    // Google Sheets config
    match /config/{configId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Reconciliation reports
    match /reconciliation_reports/{reportId} {
      allow read: if isManagerOrAdmin();
      allow write: if false; // Only Cloud Functions
    }

    // Prepaid credits
    match /prepaid_credits/{creditId} {
      allow read: if isAuthenticated();
      allow create: if isManagerOrAdmin();
      allow update: if isManagerOrAdmin();
      allow delete: if false;
    }
  }
}
